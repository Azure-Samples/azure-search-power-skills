{"get_pdf_text.output":"Phi-3 Technical Report:\nA Highly Capable Language Model Locally on Your Phone\nMicrosoft\nAbstract\nWe introduce phi-3-mini , a 3.8 billion parameter language model trained on 3.3 trillion tokens,\nwhose overall performance, as measured by both academic benchmarks and internal testing, rivals\nthat of models such as Mixtral 8x7B and GPT-3.5 (e.g., phi-3-mini achieves 69% on MMLU and\n8.38 on MT-bench), despite being small enough to be deployed on a phone. Our training dataset\nis a scaled-up version of the one used for phi-2 , composed of heavily filtered publicly available web\ndata and synthetic data. The model is also further aligned for robustness, safety, and chat format.\nWe also provide parameter-scaling results with a 7B, 14B models trained for 4.8T tokens, called phi-\n3-small ,phi-3-medium , both significantly more capable than phi-3-mini (e.g., respectively 75%,\n78% on MMLU, and 8.7, 8.9 on MT-bench). To enhance multilingual, multimodal, and long-context\ncapabilities, we introduce three models in the phi-3.5 series: phi-3.5-mini ,phi-3.5-MoE , and phi-\n3.5-Vision . The phi-3.5-MoE , a 16 x 3.8B MoE model with 6.6 billion active parameters, achieves\nsuperior performance in language reasoning, math, and code tasks compared to other open-source\nmodels of similar scale, such as Llama 3.1 and the Mixtral series, and on par with Gemini-1.5-Flash\nand GPT-4o-mini. Meanwhile, phi-3.5-Vision , a 4.2 billion parameter model derived from phi-3.5-\nmini , excels in reasoning tasks and is adept at handling both single-image and text prompts, as well\nas multi-image and text prompts.\n1 Introduction\nThe striking progress of AI in the last few years can be largely attributed to major efforts through-\nout the world towards scaling-up to ever-larger models and datasets. Large Language Models (LLMs)\nhave steadily increased in size from a mere billion parameters just five years ago (GPT-2 had 1.5 bil-\nlion parameters [RWC+19]) to trillion parameters today. The impetus for this effort originates in the\nseemingly predictable improvement one obtains by training large models, the so-called scaling laws\n[KMH+20, HBM+22, MRB+23]. However these laws assume a “fixed” data source. This assumption is\nnow significantly disrupted by the existence of frontier LLMs themselves, which allow us to interact with\ndata in novel ways. In our previous works on the phi models [GZA+23, LBE+23, JBA+23] it was shown\nthat a combination of LLM-based filtering of publicly available web data, and LLM-created synthetic\ndata, enable performance in smaller language models that were typically seen only in much larger mod-\nels. For example our previous model trained on this data recipe, phi-2 (2.7B parameters), matched the\nperformance of models 25 times larger trained on regular data. In this report we present a new model,\nphi-3-mini (3.8B parameters), trained for 3.3T tokens on larger and more advanced versions of the\ndatasets used in phi-2 . With its small size, phi-3-mini can easily be inferenced locally on a modern\nphone (see Figure 2), yet it achieves a quality that seems on-par with models such as Mixtral 8x7B\n[JSR+24] and GPT-3.5.\n1arXiv:2404.14219v4  [cs.CL]  30 Aug 2024User: Explain why it is surprising that one can build a language model small enough to\nfit on a phone, yet almost as powerful as ChatGPT. Just use one funny sentence.\nphi-3-mini: It’s like fitting a supercomputer in a flip phone, but instead of breaking\nthe phone, it just breaks the internet with its tiny, yet mighty, linguistic prowess!\nUser: Okay now more serious answer, and note that this was achieved solely by changing\nthe training data.\nphi-3-mini: The development of a compact language model that rivals the capabilities\nof ChatGPT, while fitting on a phone, is a testament to the power of data-driven\nmachine learning. By meticulously curating and optimizing the training dataset,\nresearchers can significantly reduce the model’s size without compromising its\nperformance. [...]\n2 Technical Specifications\nThephi-3-mini model is a transformer decoder architecture [VSP+17], with default context length 4 K.\nWe also introduce a long context version via LongRope [DZZ+24a] that extends the context length to\n128K, called phi-3-mini-128K .\nTo best benefit the open source community, phi-3-mini is built upon a similar block structure as\nLlama-2 [TLI+23] and uses the same tokenizer with vocabulary size of 320641. This means that all\npackages developed for Llama-2 family of models can be directly adapted to phi-3-mini . The model\nuses 3072 hidden dimension, 32 heads and 32 layers. We trained using bfloat16 for a total of 3.3T tokens.\nThe model is already chat-finetuned, and the chat template is as follows:\n<|user|> /n Question <|end|> /n <|assistant|>\nThephi-3-small model (7B parameters) leverages the tiktoken tokenizer (for better multilingual\ntokenization) with a vocabulary size of 1003522and has default context length 8192. It follows the\nstandard decoder architecture of a 7B model class, having 32 heads, 32 layers and a hidden size of 4096.\nWe switched to GEGLU activation and used Maximal Update Parametrization (muP) [YHB+22] to tune\nhyperparameters on a small proxy model and transfer them to the target 7B model. Those helped ensure\nbetter performance and training stability. Also, the model leverages a grouped-query attention, with\n4 queries sharing 1 key. To optimize the training and inference speed, we design a novel blocksparse\nattention module. For each attention head, the blocksparse attention enforces different sparsity patterns\nover KV cache. This ensures that all tokens are attended to on different heads for the given choice of\nsparsity. As illustrated in Figure 1, the context is then efficiently divided and conquered among attention\nheads, with significant KV cache reduction. To achieve actual deployment speed-up from the blocksparse\ndesign, we implemented highly efficient, yet flexible kernels for both training and inference. For training,\nwe build a triton kernel based on Flash Attention [DFE+22]. For inference, we implemented a kernel for\nthe prefilling phase and extended the paged attention kernel in vLLM for the decoding phase [KLZ+23].\nLastly, in phi-3-small architecture, we alternate dense attention layers and blocksparse attention layers\nto optimize KV cache savings while maintaining long context retrieval performance. An additional 10%\nmultilingual data was also used for this model.\nThephi-3.5-MoE adopts an Mixture-of-Experts (MoE) architecture to selectively activate parts of\nmodules on specific inputs to improve the model efficiency. It incorporates MoE layer as its feedforward\nmodels, employing the top2 routing among 16 expert networks. Particularly, each expert network is a\nseparate GLU network and the routing module will selectively activate 2 expert networks out of the\n16 expert networks for each token, leaving 16 ×3.8B model to have 6.6B activated parameters with 42B\n1We remove BoS tokens and add some additional tokens for chat template.\n2We remove unused tokens from the vocabulary.\n2Figure 1: Toy illustration of the blocksparse attention in phi-3-small with 2 local blocks and vertical stride of 3.\nThe table shows the Keys/values a query token in block 8 attended to. Blue=local blocks, orange=remote/vertical\nblocks, gray=blocks skipped.\ntotal parameters. Additionally, we utilize the SparseMixer approach [LGC23, LDL+23] for training the\nsparse router in the MoE model. For comparison with other Phi series models, phi-3.5-MoE uses the\nsame tokenizer as phi-3-medium andphi-3-mini with vocabulary size of 32064.\nHighly capable language model running locally on a cell-phone. Thanks to its small size, phi-\n3-mini can be quantized to 4-bits so that it only occupies ≈1.8GB of memory. We tested the quantized\nmodel by deploying phi-3-mini on iPhone 14 with A16 Bionic chip running natively on-device and fully\noffline achieving more than 12 tokens per second.\nTraining Methodology. We follow the sequence of works initiated in “Textbooks Are All You\nNeed” [GZA+23], which utilize high quality training data to improve the performance of small language\nmodels and deviate from the standard scaling-laws . In this work we show that such method allows to\nreach the level of highly capable models such as GPT-3.5 or Mixtral with only 3.8B total parameters\n(while Mixtral has 45B total parameters for example). Our training data of consists of heavily filtered\npublicly available web data (according to the “educational level”) from various open internet sources, as\nwell as synthetic LLM-generated data. Pre-training is performed in two disjoint and sequential phases;\nphase-1 comprises mostly of web sources aimed at teaching the model general knowledge and language\nunderstanding. Phase-2 merges even more heavily filtered webdata (a subset used in Phase-1) with some\nsynthetic data that teach the model logical reasoning and various niche skills.\nData Optimal Regime. Unlike prior works that train language models in either “compute optimal\nregime” [HBM+22] or “over-train regime”, we mainly focus on the quality of data for a given scale .3\nWe try to calibrate the training data to be closer to the “data optimal” regime for small models. In\nparticular, we filter the publicly available web data to contain the correct level of “knowledge” and keep\nmore web pages that could potentially improve the “reasoning ability” for the model. As an example, the\nresult of a game in premier league in a particular day might be good training data for frontier models,\nbut we need to remove such information to leave more model capacity for “reasoning” for the mini size\nmodels. We compare our approach with Llama-2 in Figure 3.\nTo test our data on larger size of models, we also trained phi-3-medium , a model with 14B pa-\nrameters using the same tokenizer and architecture of phi-3-mini , and trained on the same data for\nslightly more epochs (4.8T tokens total as for phi-3-small . The model has 40 heads and 40 layers, with\nembedding dimension 5120. We observe that some benchmarks improve much less from 7B to 14B than\nthey do from 3.8B to 7B, perhaps indicating that our data mixture needs further work to be in the “data\noptimal regime” for 14B parameters model.\n3Just like for “compute optimal regime”, we use the term “optimal” in an aspirational sense for “data optimal regime”.\nWe are not implying that we actually found the provably “optimal” data mixture for a given scale.\n3Figure 2: 4-bit quantized phi-3-mini running natively on an iPhone with A16 Bionic chip, generating over 12\ntokens per second.\nFigure 3: Scaling law close to the “Data Optimal Regime” (from left to right: phi-1.5, phi-2, phi-3-mini, phi-3-\nsmall) versus Llama-2 family of models (7B, 13B, 34B, 70B) that were trained on the same fixed data. We plot\nthe log of MMLU error versus the log of model size.\n4Post-training. Post-training of phi-3 went through two stages, including supervised finetuning (SFT)\nand direct preference optimization (DPO). SFT leverages highly curated high-quality data across diverse\ndomains, e.g., math, coding, reasoning, conversation, model identity, and safety. The SFT data mix\nstarts with using English-only examples. DPO data covers chat format data, reasoning, and responsible\nAI (RAI) efforts. We use DPO to steer the model away from unwanted behavior, by using those outputs\nas “rejected” responses. Besides improvement in math, coding, reasoning, robustness, and safety, post-\ntraining transforms a language model to an AI assistant that users can efficiently and safely interact\nwith.\n3 Academic benchmarks\nOn the next page we report the results for phi-3 on standard open-source benchmarks measuring the\nmodel’s reasoning ability (both common sense reasoning and logical reasoning). We compare to phi-2\n[JBA+23], Mistral-7b-v0.1 [JSM+23], Mixtral-8x7b [JSR+24], Gemma 7B [TMH+24], Llama-3-instruct-\n8b [AI23], and GPT-3.5. All the reported numbers are produced with the exact same pipeline to ensure\nthat the numbers are comparable. These numbers might differ from other published numbers due to\nslightly different choices in the evaluation. As is now standard, we use few-shot prompts to evaluate\nthe models, at temperature 0. The prompts and number of shots are part of a Microsoft internal tool\nto evaluate language models, and in particular we did no optimization to the pipeline for the phi-3\nmodels.4The number of k–shot examples is listed per-benchmark. An example of a 2-shot prompt is\ndescribed in Appendix A.\n4For example, we found that using ## before the Question can lead to a noticeable improvement to phi-3-mini ’s\nresults across many benchmarks, but we did not do such changes in the prompts.\n5Phi-3-mini\n3.8bPhi-3-small\n7bPhi-3-medium\n14bPhi-2\n2.7bMistral\n7bGemma\n7bLlama-3-In\n8bMixtral\n8x7bGPT-3.5\nversion 1106\nMMLU\n(5-Shot) [HBK+21a]68.8 75.7 78.0 56.3 61.7 63.6 66.5 70.5 71.4\nHellaSwag\n(5-Shot) [ZHB+19]76.7 77.0 82.4 53.6 58.5 49.8 71.1 70.4 78.8\nANLI\n(7-Shot) [NWD+20]52.8 58.1 55.8 42.5 47.1 48.7 57.3 55.2 58.1\nGSM-8K\n(8-Shot; CoT) [CKB+21]82.5 89.6 91.0 61.1 46.4 59.8 77.4 64.7 78.1\nMATH\n(0-Shot; CoT) [HBK+21b]41.3 34.6 53.1 – 15.0 13.6 28.2 11.1 45.3\nMedQA\n(2-Shot) [JPO+20]53.8 65.4 69.9 40.9 50.0 49.6 60.5 62.2 63.4\nAGIEval\n(0-Shot) [ZCG+23]37.5 45.1 50.2 29.8 35.1 42.1 42.0 45.2 48.4\nTriviaQA\n(5-Shot) [JCWZ17]64.0 58.1 73.9 45.2 75.2 72.3 67.7 82.2 85.8\nArc-C\n(10-Shot) [CCE+18]84.9 90.7 91.6 75.9 78.6 78.3 82.8 87.3 87.4\nArc-E\n(10-Shot) [CCE+18]94.6 97.0 97.7 88.5 90.6 91.4 93.4 95.6 96.3\nPIQA\n(5-Shot) [BZGC19]84.2 86.9 87.9 60.2 77.7 78.1 75.7 86.0 86.6\nSociQA\n(5-Shot) [BZGC19]76.6 79.2 80.2 68.3 74.6 65.5 73.9 75.9 68.3\nBigBench-Hard\n(3-Shot; CoT) [SRR+22, SSS+22]71.7 79.1 81.4 59.4 57.3 59.6 51.5 69.7 68.32\nWinoGrande\n(5-Shot) [SLBBC19]70.8 81.5 81.5 54.7 54.2 55.6 65.0 62.0 68.8\nOpenBookQA\n(10-Shot) [MCKS18]83.2 88.0 87.4 73.6 79.8 78.6 82.6 85.8 86.0\nBoolQ\n(2-Shot) [CLC+19]77.2 84.8 86.5 – 72.2 66.0 80.9 77.6 79.1\nCommonSenseQA\n(10-Shot) [THLB19]80.2 80.0 82.8 69.3 72.6 76.2 79.0 78.1 79.6\nTruthfulQA\n(10-Shot; MC2) [LHE22]65.0 70.2 75.1 – 53.0 52.1 63.2 60.1 85.8\nHumanEval\n(0-Shot) [CTJ+21]58.5 61.0 62.2 59.0 28.0 34.1 60.4 37.8 62.2\nMBPP\n(3-Shot) [AON+21]70.0 71.7 75.2 60.6 50.8 51.5 67.7 60.2 77.8\nAverage 69.7 73.6 76.7 – 58.9 59.3 67.3 66.8 72.8\nGPQA\n(2-Shot; CoT) [RHS+23]32.8 34.3 – – – – – – 29.0\nMT Bench\n(2 round ave.) [ZCS+23]8.38 8.70 8.91 – – – – – 8.35\n4 Multilingual and Long Context\nTo enhance the Phi-3 models with multilingual and long-context capabilities, we developed the ver-\nsions phi-3.5-mini andphi-3.5-MoE , which incorporate more multilingual and long-text data during\nmid-training. Specifically, we employed the long-rope method [DZZ+24a] and a mixed context window\napproach to expand the context length limit from 4K to 128K without compromising performance on\n4K-context tasks.\nFigure 4 compares the performance of phi-3-mini ,phi-3.5-mini , and phi-3.5-MoE on MMLU\nmultilingual tasks. phi-3.5-mini demonstrates significant improvement over phi-3-mini in languages\n6Model Ctx Size Python C++ Rust Java TypeScript Average\ngpt-4O-2024-05-13 128k 95 80 85 96 97 90.6\ngemini-1.5-flash-latest 1000k 93 79 87 94 97 90\nPhi-3.5-MoE 128k 89 74 81 88 95 85\nPhi-3.5-Mini 128k 86 67 73 77 82 77\nLlama-3.1-8B-Instruct 128k 80 65 73 76 63 71\nMixtral-8x7B-Instruct-v0.1 32k 66 65 64 71 74 68\nMixtral-8x22B-Instruct-v0.1 64k 60 67 74 83 55 67.8\nTable 1: Comparison results on RepoQA benchmark.\nsuch as Arabic, Chinese, Russian, Ukrainian, and Vietnamese, with average MMLU-multilingual scores\nof 55.4 and 47 .3, respectively. Due to its larger model capacity, phi-3.5-MoE achieves a significantly\nhigher average score of 69 .9, outperforming phi-3.5-mini .\nFigure 4: Comparison of phi-3-mini ,phi-3.5-mini andphi-3.5-MoE on MMLU-Multilingual tasks\nWe evaluate the phi-3.5-mini andphi-3.5-MoE models on two long-context understanding tasks:\nRULER [HSK+24] and RepoQA [LTD+24]. As shown in Tables 1 and 2, both phi-3.5-MoE andphi-\n3.5-mini outperform other open-source models with larger sizes, such as Llama-3.1-8B, Mixtral-8x7B,\nand Mixtral-8x22B, on the RepoQA task, and achieve comparable performance to Llama-3.1-8B on\nthe RULER task. However, we observe a significant performance drop when testing the 128K context\nwindow on the RULER task. We suspect this is due to the lack of high-quality long-context data in\nmid-training, an issue we plan to address in the next version of the model release.\nIn the table 3, we present a detailed evaluation of the phi-3.5-mini andphi-3.5-MoE models\ncompared with recent SoTA pretrained language models, such as GPT-4o-mini, Gemini-1.5 Flash, and\nopen-source models like Llama-3.1-8B and the Mistral models. The results show that phi-3.5-mini\nachieves performance comparable to much larger models like Mistral-Nemo-12B and Llama-3.1-8B, while\nphi-3.5-MoE significantly outperforms other open-source models, offers performance comparable to\nGemini-1.5 Flash, and achieves above 90% of the average performance of GPT-4o-mini across various\nlanguage benchmarks.\n7Model Ctx Size 4k 8k 16k 32k 64k 128k Average\nLlama-3.1-8B-Instruct 128k 95.5 93.8 91.6 87.4 84.7 77.0 88.3\nPhi-3.5-MoE 128k 94.8 93.0 93.2 91.6 85.7 64.2 87.1\nPhi-3.5-Mini 128k 94.3 91.1 90.7 87.1 78.0 63.6 84.1\nMixtral-8x22B-Instruct-v0.1 64k 95.6 94.9 93.4 90.9 84.7 31.7 81.9\nMixtral-8x7B-Instruct-v0.1 32k 94.9 92.1 92.5 85.9 72.4 44.5 80.4\nTable 2: Comparison results on RULER benchmark.\n5 Safety\nPhi-3-mini was developed in accordance with Microsoft’s responsible AI principles. The overall ap-\nproach consisted of safety alignment in post-training, red-teaming, automated testing and evaluations\nacross dozens of RAI harm categories. Helpfulness and harmlessness preference datasets [BJN+22,\nJLD+23] with modifications inspired by [BSA+24] and multiple in-house generated datasets were lever-\naged to address the RAI harm categories in safety post-training. An independent red team at Microsoft\niteratively examined phi-3-mini to further identify areas of improvement during the post-training pro-\ncess. Based on their feedback, we curated additional datasets tailored to address their insights, thereby\nrefining the post-training dataset. This process resulted in significant decrease of harmful response rates,\nas shown in Figure 5.\nFigure 5: Comparison of harmful response percentages by Microsoft AI Red Team between phi-3-mini before\nand after the safety alignment. Note that the harmful response percentages in this chart are inflated numbers as\nthe red team tried to induce phi-3-mini in an adversarial way to generate harmful responses through multi-turn\nconversations.\nThe safety alignment of phi-3-small ,phi-3-medium andphi-3.5-MoE was conducted by un-\ndergoing the same red-teaming process, utilizing identical datasets, and incorporating a slightly larger\nnumber of samples. Table 4 shows the results of in-house RAI benchmarks [MHJ+23] for phi-3 models\ncompared to phi-2 [JBA+23], Mistral-7b-v0.1 [JSM+23], Gemma 7b [TMH+24], and Llama-3-instruct-8b\n[AI23]. This benchmark utilized GPT-4 to simulate multi-turn conversations in five different categories\n8Category BenchmarkPhi-3.5-mini\n3.8BPhi-3.5-MoE\n16x3.8BMistral\n7BMistral-Nemo\n12BLlama-3.1-In\n8BGemma-2\n9BGemini-1.5\nFlashGPT-4o-mini\nPopularArena Hard 37 37.9 18.1 39.4 25.7 42 55.2 75\nBigBench Hard\nCoT (0-shot)69 79.1 33.4 60.2 63.4 63.5 66.7 80.4\nMMLUMMLU\n(5-shot)69 78.9 60.3 67.2 68.1 71.3 78.7 77.2\nMMLU-Pro\n(0-shot, CoT)47.5 54.3 18 40.7 44 50.1 57.2 62.8\nReasoningARC Challenge\n(10-shot)84.6 91.0 77.9 84.8 83.1 89.8 92.8 93.5\nBoolQ\n(2-shot)78 84.6 80.5 82.5 82.8 85.7 85.8 88.7\nGPQA\n(0-shot, CoT)27.2 36.8 15.6 28.6 26.3 29.2 37.5 41.1\nHellaSwag\n(5-shot)69.4 83.8 71.6 76.7 73.5 80.9 67.5 87.1\nOpenBookQA\n(10-shot)79.2 89.6 78 84.4 84.8 89.6 89 90\nPIQA\n(5-shot)81 88.6 73.4 83.5 81.2 83.7 87.5 88.7\nSocial IQA\n(5-shot)74.7 78.0 73 75.3 71.8 74.7 77.8 82.9\nTruthfulQA\n(10-shot,MC2)64 77.5 64.7 68.1 69.2 76.6 76.6 78.2\nWinoGrande\n(5-shot)68.5 81.3 58.1 70.4 64.7 74 74.7 76.9\nMultilingualMl MMLU\n(5-shot)55.4 69.9 47.4 58.9 56.2 63.8 77.2 72.9\nMGSM\n(0-shot CoT)47.9 58.7 31.8 63.3 56.7 76.4 75.8 81.7\nMathGSM8K\n(8-shot, CoT)86.2 88.7 54.4 84.2 82.4 84.9 82.4 91.3\nMATH\n(0-shot, CoT)48.5 59.5 19 31.2 47.6 50.9 38 70.2\nLong contextQasper 41.9 40.0 31.4 30.7 37.2 13.9 43.5 39.8\nSQuALITY 24.3 24.1 25.9 25.8 26.2 0 23.5 23.8\nCodeHumanEval\n(0-shot)61.5 70.7 35.4 63.4 66.5 61 74.4 86.6\nMBPP\n(3-shot)68.6 80.8 50.4 68.1 69.4 69.3 77.5 84.1\nAverage 61.1 69.2 48.5 61.3 61.0 63.3 68.5 74.9\nTable 3: Model quality on representative benchmarks\nand to evaluate the model responses. Ungroundedness between 0 (fully grounded) and 4 (not grounded)\nmeasures if the information in a response is based on a given prompt. In other categories, responses\nwere evaluated in terms of the severity of harmfulness from 0 (no harm) to 7 (extreme harm) and the\ndefect rates (DR- x) were computed as the percentage of samples with the severity score being greater\nthan or equal to x.\n6 Weakness\nIn terms of LLM capabilities, while phi-3-mini model achieves similar level of language understanding\nand reasoning ability as much larger models, it is still fundamentally limited by its size for certain tasks.\nThe model simply does not have the capacity to store too much “factual knowledge”, which can be seen\nfor example with low performance on TriviaQA. However, we believe such weakness can be resolved by\naugmentation with a search engine. We show an example using the HuggingFace default Chat-UI with\n9Phi-3-mini\n3.8bPhi-3-small\n7bPhi-3-medium\n14bPhi-3.5-MoE\n16x3.8bPhi-2\n2.7bMistral\n7bGemma\n7bLlama-3-In\n8b\nUngroundedness 0.603 0.299 0.213 0.228 1.481 0.935 0.679 0.328\nThird Party Harm (DR-1) 0.240 0.253 0.251 0.105 0.240 0.562 0.383 0.373\nHarmful Content Continuation (DR-3) 0.007 0.003 0.010 0.005 0.029 0.026 0.013 0.013\nHarmful Content Summarization (DR-3) 0.100 0.110 0.112 0.12 0.144 0.223 0.103 0.082\nJailbreak (DR-1) 0.123 0.107 0.111 0.106 0.150 0.156 0.114 0.130\nTable 4: Comparison of Microsoft internal multi-turn conversation RAI benchmark results of phi-3 models and\nother models. Note that a lower value indicates a better performance for all metrics in the table.\nphi-3-mini in Figure 6. Another weakness related to model’s capacity is that we mostly restricted the\nlanguage to English. Exploring multilingual capabilities for Small Language Models is an important\nnext step, with some initial promising results on phi-3-small by including more multilingual data.\nDespite our diligent RAI efforts, as with most LLMs, there remains challenges around factual inaccu-\nracies (or hallucinations), reproduction or amplification of biases, inappropriate content generation, and\nsafety issues. The use of carefully curated training data, and targeted post-training, and improvements\nfrom red-teaming insights significantly mitigates these issues across all dimensions. However, there is\nsignificant work ahead to fully address these challenges, and downstream use of the models should be\nevaluated for the specific use cases and safety considerations for that context.\n7 Phi-3.5-Vision\n7.1 Technical Specifications\nArchitecture ThePhi-3.5-Vision (4.2B parameters) is a multimodal model designed to process an\nimage/multi-image and a textual prompt as inputs, and subsequently generate textual outputs. This\nmodel is composed of two primary components: an image encoder, i.e., CLIP ViT-L/14 [RKH+21] and a\ntransformer decoder, i.e., phi-3.5-mini. The visual tokens, once extracted by the image encoder, are then\ncombined with text tokens in an interleaved way (no particular order for image and text tokens). To\naccommodate high-resolution images and various aspect ratios, a dynamic cropping strategy [DZZ+24b] is\nutilized to split the input image into a 2d array of blocks, where the tokens of the blocks are concatenated\nto represent the whole image. For multi-image input, we simply concatenated tokens from each images\ntogether.\nPre-training ThePhi-3.5-Vision model undergoes a pre-training phase using a diverse dataset,\nwhich consists of a combination of interleaved image-text documents ( e.g., [LST+24]), image-text pairs\nfrom FLD-5B [XWX+24], synthetic data derived from Optical Character Recognition (OCR) of PDF\nfiles, datasets for chart/table comprehension, and text-only data. The objective of predicting the next\ntoken is employed specifically on text tokens, while any loss associated with image tokens is disregarded\nduring this phase. The pre-training process involves a total of 0 .5Ttokens that encompass both visual\nand text elements. During the pre-training phase, the maximum image resolution is capped at 1344 ×1344\nas the majority of the training images are smaller than this resolution.\nPost-training. ThePhi-3.5-Vision model contains two post-training stages: supervised finetuning\n(SFT) and direct preference optimization (DPO). For SFT, we leveraged text SFT dataset, public multi-\nmodal instruct tuning datasets along with large-scale multimodal instruct tuning datasets that we built\n10Figure 6: Left: phi-3-mini ’s completion without search. Right: phi-3-mini ’s completion with search, using the\ndefault HuggingFace Chat-UI search ability. For reference, the 2026 Winter Olympic Games are scheduled to be\nheld in Milano and Cortina in Italy, while the 2022 and 2018 Winter Olympic Games were held in Beijing, China\nand PyeongChang, Korea, respectively. Without the search results, the response is incorrect, while with the web\nsearch, not only does the response become accurate, but also gets more specific with suggestions.\n11Figure 7: The demo case shows Phi-3.5-Vision’s capability in natural image understanding and reasoning.\nourselves, covering diverse domains and tasks such as general natural image understanding, chart/table/-\ndiagram understanding/reasoning, PowerPoint understanding, multi-image comparison, video summa-\nrization and model safety. The multimodal SFT data has about a total of 33B tokens. For DPO we\nmainly use a text DPO dataset and a relatively smaller-scale multimodal DPO dataset. For these two\nstages, we jointly train multimodal tasks and text-only tasks so that the model can achieve multi-modal\nreasoning while maintaining language capabilities as much as possible.\n7.2 Academic benchmarks\n7.2.1 Single-image Benchmarks\nWe report in Table 5 the evaluation results of Phi-3.5-Vision on nine open-source academic benchmarks.\nThese benchmarks evaluate reasoning and perceptual capabilities on visual and text inputs and can\nbe grouped in three categories: Science, Charts, and Generic knowledge. We compare Phi-3.5-Vision\nwith the following baselines: MM1-3B-Chat [MGF+24], MM1-7B-Chat [MGF+24], Llava-1.6 Vicuna\n7B [LLLL23], Llava-1.6 Llama3-8B [LLL+24], Qwen-VL-Chat [BBY+23], Claude 3 Haiku [Ant24], Gemini\n1.0 Pro V [TAB+23], and GPT-4O. Our performance quality assessment setup used the same evaluation\npipeline for all the baselines to ensure a fair comparison, with the exception of MM1-3B-Chat. We just\ncopied and pasted their published numbers since the model is not publicly available.\nOur evaluation setup aimed to mimic scenarios where regular users interact with a multi-modal\nmodel, i.e., users who are not experts in prompt engineering or know special techniques that can improve\nperformance. For this reason, we adopted the evaluation setting used in Llava-1.5 [LLLL23]. In this\n12setup, the prompts include instructions to select a single letter corresponding to an answer from a list\nof given options, or answer with a single word or phrase. In our prompts, we did not use specific tokens\nfor multiple-choice questions. Moreover, we did not scale or pre-process any image in our benchmarking\nsystem. We placed the images as the first item in the prompts, except on the MMMU dataset where\nthe prompts interleave the images anywhere in the question or the answers. Lastly, our evaluation\nsetup only considered a 0-shot format. Because of these evaluation parameters, our reported numbers\ncan differ from the published numbers of the considered baselines. As we can seen, our Phi-3.5-Vision\nachieves super competitive results on all benchmarks and outperform other competitor models on most\nbenchmarks while being smaller.\n7.2.2 Multi-image Benchmarks\nWe report in Table 6 the evaluation results of Phi-3.5-Vision on one latest academic multi-image bench-\nmark and one video benchmark. These benchmarks evaluate perceptual capabilities on multiple im-\nage/frames and text covering a wide range of general scenarios (e.g., Art and Style recognition, Forensic\ndetection, and video understanding). We compare Phi-3.5-Vision with the following baseline methods:\nLlava Interleave-Qwen 7B [LZZ+24], InternVL2 4B and 8B [CWT+24], Gemini 1.5 Flash [TAB+23],\nGPT-4o-mini, Claude 3.5 Sonnet [Ant24], Gemini 1.5 Pro [TAB+23], and GPT-4O. Line in the single-\nframe evaluation case, our performance quality assessment setup used the same evaluation pipeline for\nall the baselines to ensure a fair comparison.\nOur evaluation setup for multi-image also followed the Llava setup where prompts include instructions\nto select a single letter corresponding to an answer from a list of given options, or answer with a single\nword or phrase. Moreover, we did not use specific tokens for multiple-choice questions and we did not\nscale or pre-process any image in our benchmarking system. For most of the benchmarks, we placed the\nimages as the first item in the prompts.\nThe evaluation pipelines for BLINK and VideoMME benchmarks differ from those published. In\nthe case of BLINK, we do not use ChatGPT as the final answer selection mechanism. Instead, we\ninstruct the evaluated model to select one answer directly from the given choices. The reason is that\nin this manner we ensure that the mistakes or successes come solely by the evaluated model. For the\nVideoMME benchmark, we extracted 16 frames from the video by sampling frames at a given rate that\nensures a uniform time coverage of the entire video. We used 16 frames since this is the maximum\nnumber of images a prompt can contain for Azure OpenAI models. Unlike the proposed evaluation in\nVideoMME that uses the maximum number of frames a model can accept, we always pass the same\namount of frames across all the considered model baselines. In this way we ensure the evaluations are\nfair since all the models receive the exact same input information (i.e., the prompt and set of images).\nAs shown in Table 6, our Phi-3.5-Vision performs very competitively or outperforms baseline models\nunder the similar model size in multi-image understanding scenarios as well.\n7.3 Safety\nTo ensure the integration of Phi-3.5-Vision aligns with Microsoft’s Responsible AI (RAI) principles,\nwe involved safety post-training in both Supervised Fine-Tuning (SFT) stage and Direct Preference\nOptimization (DPO) stage. In creating the safety training datasets, we utilized not only the text-\nonly RAI datasets, but also a variety of in-house Multi-Modal (MM) RAI datasets that cover various\nharm categories identified in both public and internal MM RAI benchmarks. For the purpose of RAI\nevaluation, we performed a rigorous quantitative assessment on both public and internal benchmarks,\nthis was done in conjunction with a human evaluation conducted by Microsoft’s internal red team.\n13Phi-3.5-Vision\n4.2b\nMM1-3B-Chat\n3.6b [MGF+24]\nMM1-7B-Chat\n7.6b [MGF+24]\nLLaVA-1.6\nVicuna-7b [LLLL23]\nLLaVA-Next\nLLama3-8b [LLL+24]\nQwen-VL-Chat\n9.6b [BBY+23]\nClaude 3 haiku\n[Ant24]\nGemini 1.0 Pro V\n[TAB+23]\nGPT-4O\n2024-05-13\nMMMU\n(val) [YNZ+23]43.0 33.9 37.0 34.2 36.4 39.0 40.7 42.0 61.8\nScienceQA\n(test) [LMX+22]91.3 69.4 72.6 70.6 73.7 67.2 72.0 79.7 88.5\nMathVista\n(testmini) [LBX+24]43.9 32.0 35.9 31.5 34.8 29.4 33.2 35.0 54.4\nInter-GPS\n(test) [LGJ+21]36.3 - - 20.5 24.6 22.3 32.1 28.6 46.9\nMMBench\n(dev-en) [LDZ+24]81.9 75.9 79.0 76.3 79.4 75.8 62.4 80.0 88.4\nPOPE\n(test) [LDZ+23]86.1 87.4 86.6 87.2 87.0 82.6 74.4 84.2 87.0\nAI2D\n(test) [KSK+16]78.1 - - 63.1 66.9 59.8 60.3 62.8 82.8\nChartQA\n(test) [MLT+22]81.8 - - 55.0 65.8 50.9 59.3 58.0 64.0\nTextVQA\n(test) [SNS+19]72.0 71.9 72.8 64.6 55.7 59.4 62.7 64.7 75.6\nTable 5: Comparison results on public MLLM benchmarks. All the reported numbers are produced with the exact\nsame pipeline to ensure that the numbers are comparable except for MM1-3B-Chat [MGF+24] and MM1-7B-\nChat [MGF+24], which are not publicly available. We adopted the evaluation setting used in Llava-1.5 [LLLL23],\nwithout any specific prompt or pre-processing image for all results. These numbers might differ from other\npublished numbers due to slightly different prompts.\nIn Table 7, we present the evaluation outcomes of Phi-3.5-Vision on three MM RAI benchmarks:\none internal and two public benchmarks (specifically, RTVLM [LLY+24] and VLGuard [ZBY+24]). We\njuxtapose these results with those of other open-source models such as Llava-1.5 [LLLL23], Llava-1.6\n[LLL+24], Qwen-VL-Chat [BBY+23], and GPT4-V[Ope23]. The results clearly indicate that safety\npost-training notably enhances the RAI performance of Phi-3.5-Vision across all RAI benchmarks. In\nFigure 8, we further breakdown the performance across different RAI categories of the VLGuard and\nInternal benchmarks, demonstrating that safety post-training can aid Phi-3.5-Vision in improving RAI\nperformance in nearly all categories.\n7.4 Weakness\nRegarding the multi-modal LLM capabilities of our Phi-3.5-Vision, it performs admirably across various\nfields. However, we have identified certain limitations, particularly with questions necessitating high-\nlevel reasoning abilities. Additionally, the model has been observed to occasionally generate ungrounded\noutputs, making it potentially unreliable in sensitive areas, such as finance. To mitigate these issues, we\nwill incorporate more reasoning-focused and hallucination-related DPO data into post-training in the\n14Phi-3.5-Vision\n4.2b\nLlava-interleave\nQwen 7b [LZZ+24]\nInternVL2\n4b [CWT+24]\nInternVL2\n8b [CWT+24]\nGemini 1.5\nFlash [TAB+23]\nGPT4O mini\n2024-07-18\nClaude 3.5\nSonnet [Ant24]\nGemini 1.5 Pro\n[TAB+23]\nGPT-4O\n2024-05-13\nBLINK\n(val) [FHL+24]57.0 53.1 45.9 45.4 45.8 51.9 56.5 61.0 63.2\nVideoMME\n(test) [FDL+24]50.8 50.2 49.9 52.6 62.3 61.2 55.9 62.6 68.4\nTable 6: Comparison results on public multi-image/video MLLM benchmarks. All the reported numbers are\nproduced with the exact same pipeline to ensure that the numbers are comparable.\nPhi-3.5-Vision\n3.8b+0.3bPhi-3.5-Vision w/o safety\n3.8b+0.3bLlava-1.6 Vicuna\n7b+0.3bQwen-VL-Chat\n7.7b+1.9bGPT4-V\nN/A\nInternal (private) 8.16 7.06 5.44 7.27 8.55\nRTVLM (public) 5.44 3.56 3.86 4.78 6.81\nVLGuard (public) 9.10 4.66 5.62 8.33 8.90\nTable 7: Comparison results on public and private multi-modal RAI benchmarks. Note that all metrics in the\ntable are [0,10] and a higher value indicates a better performance.\nfuture.\nFrom a responsible AI standpoint, whilst safety post-training has made significant strides, our Phi-\n3.5-Vision occasionally fails to refrain from answering harmful or sensitive inquiries. Examples of such\noccasions include deciphering particular types of captcha and describing scam images containing disin-\nformation or hallucination. We find that this issue partly arises from the capabilities, such as OCR,\nacquired during the training process with normal instruct tuning datasets, which can be regarded as the\ntrade-off between helpfulness and harmlessness. Moving forward, we need to further explore this area\nto achieve a better balance.\nReferences\n[AI23] Meta AI. Introducing meta llama 3: The most capable openly available llm to date, 2023.\n[Ant24] AI Anthropic. The claude 3 model family: Opus, sonnet, haiku. Claude-3 Model Card , 2024.\n[AON+21] Jacob Austin, Augustus Odena, Maxwell Nye, Maarten Bosma, Henryk Michalewski, David\nDohan, Ellen Jiang, Carrie Cai, Michael Terry, Quoc Le, and Charles Sutton. Program\nsynthesis with large language models. arXiv preprint arXiv:2108.07732 , 2021.\n[BBY+23] Jinze Bai, Shuai Bai, Shusheng Yang, Shijie Wang, Sinan Tan, Peng Wang, Junyang Lin,\nChang Zhou, and Jingren Zhou. Qwen-vl: A versatile vision-language model for understand-\ning, localization, text reading, and beyond, 2023.\n150246810Phi-3-Vision w/o safety Phi-3-Vision\n0246810Phi-3-Vision w/o safety Phi-3-VisionFigure 8: Comparison of categorized RAI performance of Phi-3.5-Vision with and without the safety post-training\non the VLGuard (left) and Internal (right) benchmark, respectively. It clearly indicates that safety post-training\ncan enhance the RAI performance across nearly all the RAI categories.\n[BJN+22] Yuntao Bai, Andy Jones, Kamal Ndousse, Amanda Askell, Anna Chen, Nova DasSarma,\nDawn Drain, Stanislav Fort, Deep Ganguli, Tom Henighan, Nicholas Joseph, Saurav Ka-\ndavath, Jackson Kernion, Tom Conerly, Sheer El-Showk, Nelson Elhage, Zac Hatfield-\nDodds, Danny Hernandez, Tristan Hume, Scott Johnston, Shauna Kravec, Liane Lovitt,\nNeel Nanda, Catherine Olsson, Dario Amodei, Tom Brown, Jack Clark, Sam McCandlish,\nChris Olah, Ben Mann, and Jared Kaplan. Training a helpful and harmless assistant with\nreinforcement learning from human feedback, 2022.\n[BSA+24] Federico Bianchi, Mirac Suzgun, Giuseppe Attanasio, Paul R¨ ottger, Dan Jurafsky, Tatsunori\nHashimoto, and James Zou. Safety-tuned llamas: Lessons from improving the safety of large\nlanguage models that follow instructions, 2024.\n[BZGC19] Yonatan Bisk, Rowan Zellers, Jianfeng Gao, and Yejin Choi. Piqa: Reasoning about physical\ncommonsense in natural language. arXiv preprint arXiv:1911.11641 , 2019.\n[CCE+18] Peter Clark, Isaac Cowhey, Oren Etzioni, Tushar Khot, Ashish Sabharwal, Carissa\nSchoenick, and Oyvind Tafjord. Think you have solved question answering? try arc, the ai2\nreasoning challenge, 2018.\n[CKB+21] Karl Cobbe, Vineet Kosaraju, Mohammad Bavarian, Mark Chen, Heewoo Jun, Lukasz\nKaiser, Matthias Plappert, Jerry Tworek, Jacob Hilton, Reiichiro Nakano, Christopher\nHesse, and John Schulman. Training verifiers to solve math word problems. arXiv preprint\narXiv:2110.14168 , 2021.\n[CLC+19] Christopher Clark, Kenton Lee, Ming-Wei Chang, Tom Kwiatkowski, Michael Collins, and\nKristina Toutanova. Boolq: Exploring the surprising difficulty of natural yes/no questions.\nInProceedings of the 2019 Conference of the North American Chapter of the Association\nfor Computational Linguistics: Human Language Technologies, Volume 1 (Long and Short\nPapers) , pages 2924–2936, 2019.\n[CTJ+21] Mark Chen, Jerry Tworek, Heewoo Jun, Qiming Yuan, Henrique Ponde de Oliveira Pinto,\nJared Kaplan, Harri Edwards, Yuri Burda, Nicholas Joseph, Greg Brockman, Alex Ray,\n16Raul Puri, Gretchen Krueger, Michael Petrov, Heidy Khlaaf, Girish Sastry, Pamela Mishkin,\nBrooke Chan, Scott Gray, Nick Ryder, Mikhail Pavlov, Alethea Power, Lukasz Kaiser, Mo-\nhammad Bavarian, Clemens Winter, Philippe Tillet, Felipe Petroski Such, Dave Cummings,\nMatthias Plappert, Fotios Chantzis, Elizabeth Barnes, Ariel Herbert-Voss, William Hebgen\nGuss, Alex Nichol, Alex Paino, Nikolas Tezak, Jie Tang, Igor Babuschkin, Suchir Balaji,\nShantanu Jain, William Saunders, Christopher Hesse, Andrew N. Carr, Jan Leike, Josh\nAchiam, Vedant Misra, Evan Morikawa, Alec Radford, Matthew Knight, Miles Brundage,\nMira Murati, Katie Mayer, Peter Welinder, Bob McGrew, Dario Amodei, Sam McCandlish,\nIlya Sutskever, and Wojciech Zaremba. Evaluating large language models trained on code,\n2021.\n[CWT+24] Zhe Chen, Weiyun Wang, Hao Tian, Shenglong Ye, Zhangwei Gao, Erfei Cui, Wenwen Tong,\nKongzhi Hu, Jiapeng Luo, Zheng Ma, et al. How far are we to gpt-4v? closing the gap to\ncommercial multimodal models with open-source suites. arXiv preprint arXiv:2404.16821 ,\n2024.\n[DFE+22] Tri Dao, Dan Fu, Stefano Ermon, Atri Rudra, and Christopher R´ e. Flashattention: Fast\nand memory-efficient exact attention with io-awareness. Advances in Neural Information\nProcessing Systems , 35:16344–16359, 2022.\n[DZZ+24a] Yiran Ding, Li Lyna Zhang, Chengruidong Zhang, Yuanyuan Xu, Ning Shang, Jiahang Xu,\nFan Yang, and Mao Yang. Longrope: Extending llm context window beyond 2 million\ntokens, 2024.\n[DZZ+24b] Xiaoyi Dong, Pan Zhang, Yuhang Zang, Yuhang Cao, Bin Wang, Linke Ouyang, Songyang\nZhang, Haodong Duan, Wenwei Zhang, Yining Li, et al. Internlm-xcomposer2-4khd: A\npioneering large vision-language model handling resolutions from 336 pixels to 4k hd. arXiv\npreprint arXiv:2404.06512 , 2024.\n[FDL+24] Chaoyou Fu, Yuhan Dai, Yondong Luo, Lei Li, Shuhuai Ren, Renrui Zhang, Zihan Wang,\nChenyu Zhou, Yunhang Shen, Mengdan Zhang, et al. Video-mme: The first-ever com-\nprehensive evaluation benchmark of multi-modal llms in video analysis. arXiv preprint\narXiv:2405.21075 , 2024.\n[FHL+24] Xingyu Fu, Yushi Hu, Bangzheng Li, Yu Feng, Haoyu Wang, Xudong Lin, Dan Roth, Noah A\nSmith, Wei-Chiu Ma, and Ranjay Krishna. Blink: Multimodal large language models can\nsee but not perceive. arXiv preprint arXiv:2404.12390 , 2024.\n[GZA+23] Suriya Gunasekar, Yi Zhang, Jyoti Aneja, Caio C´ esar Teodoro Mendes, Allie Del Giorno,\nSivakanth Gopi, Mojan Javaheripi, Gustavo de Rosa Piero Kauffmann, Olli Saarikivia,\nAdil Salim, Shital Shah, Harkirat Singh Behl, Xin Wang, S´ ebastien Bubeck, Ronen El-\ndan, Adam Tauman Kalai, Yin Tat Lee, and Yuanzhi Li. Textbooks are all you need. arXiv\npreprint arXiv:2306.11644 , 2023.\n[HBK+21a] Dan Hendrycks, Collin Burns, Saurav Kadavath, Akul Arora, Steven Basart, Eric Tang,\nDawn Song, and Jacob Steinhardt. Measuring mathematical problem solving with the\nMATH dataset, 2021.\n[HBK+21b] Dan Hendrycks, Collin Burns, Saurav Kadavath, Akul Arora, Steven Basart, Eric Tang,\nDawn Song, and Jacob Steinhardt. Measuring mathematical problem solving with the math\ndataset. NeurIPS , 2021.\n17[HBM+22] Jordan Hoffmann, Sebastian Borgeaud, Arthur Mensch, Elena Buchatskaya, Eliza Ruther-\nford Trevor Cai, Diego de Las Casas, Lisa Anne Hendricks, Johannes Welbl, Aidan Clark,\nTom Hennigan, Eric Noland, Katie Millican, George van den Driessche, Bogdan Damoc,\nAurelia Guy, Simon Osindero, Karen Simonyan, Erich Elsen, Jack W. Rae, Oriol Vinyals,\nand Laurent Sifre. Training compute-optimal large language models. arXiv preprint\narXiv:2203.15556 , 2022.\n[HSK+24] Cheng-Ping Hsieh, Simeng Sun, Samuel Kriman, Shantanu Acharya, Dima Rekesh, Fei Jia,\nYang Zhang, and Boris Ginsburg. Ruler: What’s the real context size of your long-context\nlanguage models?, 2024.\n[JBA+23] Mojan Javaheripi, S´ ebastien Bubeck, Marah Abdin, Jyoti Aneja, Caio C´ esar\nTeodoro Mendes, Weizhu Chen, Allie Del Giorno, Ronen Eldan, Sivakanth Gopi, Suriya\nGunasekar, Piero Kauffmann, Yin Tat Lee, Yuanzhi Li, Anh Nguyen, Gustavo de Rosa, Olli\nSaarikivi, Adil Salim, Shital Shah, Michael Santacroce, Harkirat Singh Behl, Adam Tau-\nmann Kalai, Xin Wang, Rachel Ward, Philipp Witte, Cyril Zhang, and Yi Zhang. Phi-2:\nThe surprising power of small language models. Microsoft Research Blog , 2023.\n[JCWZ17] Mandar Joshi, Eunsol Choi, Daniel S. Weld, and Luke Zettlemoyer. Triviaqa: A large scale\ndistantly supervised challenge dataset for reading comprehension, 2017.\n[JLD+23] Jiaming Ji, Mickel Liu, Juntao Dai, Xuehai Pan, Chi Zhang, Ce Bian, Chi Zhang, Ruiyang\nSun, Yizhou Wang, and Yaodong Yang. Beavertails: Towards improved safety alignment of\nllm via a human-preference dataset, 2023.\n[JPO+20] Di Jin, Eileen Pan, Nassim Oufattole, Wei-Hung Weng, Hanyi Fang, and Peter Szolovits.\nWhat disease does this patient have? a large-scale open domain question answering dataset\nfrom medical exams, 2020.\n[JSM+23] Albert Q. Jiang, Alexandre Sablayrolles, Arthur Mensch, Chris Bamford, Devendra Singh\nChaplot, Diego de las Casas, Florian Bressand, Gianna Lengyel, Guillaume Lample, Lucile\nSaulnier, L´ elio Renard Lavaud, Marie-Anne Lachaux, Pierre Stock, Teven Le Scao, Thibaut\nLavril, Thomas Wang, Timoth´ ee Lacroix, and William El Sayed. Mistral 7b, 2023.\n[JSR+24] Albert Q. Jiang, Alexandre Sablayrolles, Antoine Roux, Arthur Mensch, Blanche Savary,\nChris Bamford, Devendra Singh Chaplot, Diego de las Casas, Emma Bou Hanna, Florian\nBressand, Gianna Lengyel, Guillaume Bour, Guillaume Lample, L´ elio Renard Lavaud, Lucile\nSaulnier, Marie-Anne Lachaux, Pierre Stock, Sandeep Subramanian, Sophia Yang, Szymon\nAntoniak, Teven Le Scao, Th´ eophile Gervet, Thibaut Lavril, Thomas Wang, Timoth´ ee\nLacroix, and William El Sayed. Mixtral of experts, 2024.\n[KLZ+23] Woosuk Kwon, Zhuohan Li, Siyuan Zhuang, Ying Sheng, Lianmin Zheng, Cody Hao Yu,\nJoseph E. Gonzalez, Hao Zhang, and Ion Stoica. Efficient memory management for large\nlanguage model serving with pagedattention. In Proceedings of the ACM SIGOPS 29th\nSymposium on Operating Systems Principles , 2023.\n[KMH+20] Jared Kaplan, Sam McCandlish, Tom Henighan, Tom B Brown, Benjamin Chess, Rewon\nChild, Scott Gray, Alec Radford, Jeffrey Wu, and Dario Amodei. Scaling laws for neural\nlanguage models. arXiv preprint arXiv:2001.08361 , 2020.\n18[KSK+16] Aniruddha Kembhavi, Mike Salvato, Eric Kolve, Minjoon Seo, Hannaneh Hajishirzi, and\nAli Farhadi. A diagram is worth a dozen images, 2016.\n[LBE+23] Yuanzhi Li, S´ ebastien Bubeck, Ronen Eldan, Allie Del Giorno, Suriya Gunasekar, and\nYin Tat Lee. Textbooks are all you need ii: phi-1.5 technical report. arXiv preprint\narXiv:2309.05463 , 2023.\n[LBX+24] Pan Lu, Hritik Bansal, Tony Xia, Jiacheng Liu, Chunyuan Li, Hannaneh Hajishirzi, Hao\nCheng, Kai-Wei Chang, Michel Galley, and Jianfeng Gao. Mathvista: Evaluating mathe-\nmatical reasoning of foundation models in visual contexts, 2024.\n[LDL+23] Liyuan Liu, Chengyu Dong, Xiaodong Liu, Bin Yu, and Jianfeng Gao. Bridging discrete\nand backpropagation: Straight-through and beyond. arXiv:2304.08612 , 2023.\n[LDZ+23] Yifan Li, Yifan Du, Kun Zhou, Jinpeng Wang, Wayne Xin Zhao, and Ji-Rong Wen. Evalu-\nating object hallucination in large vision-language models, 2023.\n[LDZ+24] Yuan Liu, Haodong Duan, Yuanhan Zhang, Bo Li, Songyang Zhang, Wangbo Zhao, Yike\nYuan, Jiaqi Wang, Conghui He, Ziwei Liu, Kai Chen, and Dahua Lin. Mmbench: Is your\nmulti-modal model an all-around player?, 2024.\n[LGC23] Liyuan Liu, Jianfeng Gao, and Weizhu Chen. Sparse backpropagation for moe training.\narXiv:2310.00811 , 2023.\n[LGJ+21] Pan Lu, Ran Gong, Shibiao Jiang, Liang Qiu, Siyuan Huang, Xiaodan Liang, and Song-\nChun Zhu. Inter-gps: Interpretable geometry problem solving with formal language and\nsymbolic reasoning, 2021.\n[LHE22] Stephanie Lin, Jacob Hilton, and Owain Evans. Truthfulqa: Measuring how models mimic\nhuman falsehoods, 2022.\n[LLL+24] Haotian Liu, Chunyuan Li, Yuheng Li, Bo Li, Yuanhan Zhang, Sheng Shen, and Yong Jae\nLee. Llava-next: Improved reasoning, ocr, and world knowledge, January 2024.\n[LLLL23] Haotian Liu, Chunyuan Li, Yuheng Li, and Yong Jae Lee. Improved baselines with visual\ninstruction tuning. arXiv preprint arXiv:2310.03744 , 2023.\n[LLY+24] Mukai Li, Lei Li, Yuwei Yin, Masood Ahmed, Zhenguang Liu, and Qi Liu. Red teaming\nvisual language models. arXiv preprint arXiv:2401.12915 , 2024.\n[LMX+22] Pan Lu, Swaroop Mishra, Tony Xia, Liang Qiu, Kai-Wei Chang, Song-Chun Zhu, Oyvind\nTafjord, Peter Clark, and Ashwin Kalyan. Learn to explain: Multimodal reasoning via\nthought chains for science question answering. In The 36th Conference on Neural Informa-\ntion Processing Systems (NeurIPS) , 2022.\n[LST+24] Hugo Lauren¸ con, Lucile Saulnier, L´ eo Tronchon, Stas Bekman, Amanpreet Singh, An-\nton Lozhkov, Thomas Wang, Siddharth Karamcheti, Alexander Rush, Douwe Kiela, et al.\nObelics: An open web-scale filtered dataset of interleaved image-text documents. Advances\nin Neural Information Processing Systems , 36, 2024.\n[LTD+24] Jiawei Liu, Jia Le Tian, Vijay Daita, Yuxiang Wei, Yifeng Ding, Yuhan Katherine Wang,\nJun Yang, and Lingming Zhang. Repoqa: Evaluating long context code understanding,\n2024.\n19[LZZ+24] Feng Li, Renrui Zhang, Hao Zhang, Yuanhan Zhang, Bo Li, Wei Li, Zejun Ma, and Chun-\nyuan Li. Llava-next-interleave: Tackling multi-image, video, and 3d in large multimodal\nmodels. arXiv preprint arXiv:2407.07895 , 2024.\n[MCKS18] Todor Mihaylov, Peter Clark, Tushar Khot, and Ashish Sabharwal. Can a suit of armor\nconduct electricity? a new dataset for open book question answering, 2018.\n[MGF+24] Brandon McKinzie, Zhe Gan, Jean-Philippe Fauconnier, Sam Dodge, Bowen Zhang, Philipp\nDufter, Dhruti Shah, Xianzhi Du, Futang Peng, Floris Weers, Anton Belyi, Haotian Zhang,\nKaranjeet Singh, Doug Kang, Ankur Jain, Hongyu H` e, Max Schwarzer, Tom Gunter, Xiang\nKong, Aonan Zhang, Jianyu Wang, Chong Wang, Nan Du, Tao Lei, Sam Wiseman, Guoli\nYin, Mark Lee, Zirui Wang, Ruoming Pang, Peter Grasch, Alexander Toshev, and Yinfei\nYang. Mm1: Methods, analysis & insights from multimodal llm pre-training. arXiv preprint\narXiv:2403.09611 , 2024.\n[MHJ+23] Ahmed Magooda, Alec Helyar, Kyle Jackson, David Sullivan, Chad Atalla, Emily Sheng,\nDan Vann, Richard Edgar, Hamid Palangi, Roman Lutz, Hongliang Kong, Vincent Yun,\nEslam Kamal, Federico Zarfati, Hanna Wallach, Sarah Bird, and Mei Chen. A framework\nfor automated measurement of responsible ai harms in generative ai applications, 2023.\n[MLT+22] Ahmed Masry, Do Long, Jia Qing Tan, Shafiq Joty, and Enamul Hoque. ChartQA: A\nbenchmark for question answering about charts with visual and logical reasoning. In Find-\nings of the Association for Computational Linguistics: ACL 2022 , pages 2263–2279, Dublin,\nIreland, May 2022. Association for Computational Linguistics.\n[MRB+23] Niklas Muennighoff, Alexander M Rush, Boaz Barak, Teven Le Scao, Aleksandra Piktus,\nNouamane Tazi, Sampo Pyysalo, Thomas Wolf, and Colin Raffel. Scaling data-constrained\nlanguage models. arXiv preprint arXiv:2305.16264 , 2023.\n[NWD+20] Yixin Nie, Adina Williams, Emily Dinan, Mohit Bansal, Jason Weston, and Douwe Kiela.\nAdversarial nli: A new benchmark for natural language understanding, 2020.\n[Ope23] OpenAI. Gpt-4v(ision) system card, 2023. https://cdn.openai.com/papers/GPTV_\nSystem_Card.pdf .\n[RHS+23] David Rein, Betty Li Hou, Asa Cooper Stickland, Jackson Petty, Richard Yuanzhe Pang,\nJulien Dirani, Julian Michael, and Samuel R. Bowman. Gpqa: A graduate-level google-proof\nq&a benchmark, 2023.\n[RKH+21] Alec Radford, Jong Wook Kim, Chris Hallacy, Aditya Ramesh, Gabriel Goh, Sandhini Agar-\nwal, Girish Sastry, Amanda Askell, Pamela Mishkin, Jack Clark, et al. Learning transferable\nvisual models from natural language supervision. In International conference on machine\nlearning , pages 8748–8763. PMLR, 2021.\n[RWC+19] Alec Radford, Jeffrey Wu, Rewon Child, David Luan, Dario Amodei, and Ilya Sutskever.\nLanguage models are unsupervised multitask learners. OpenAI blog , 1(8):9, 2019.\n[SLBBC19] Keisuke Sakaguchi, Ronan Le Bras, Chandra Bhagavatula, and Yejin Choi. Winogrande:\nAn adversarial winograd schema challenge at scale. arXiv preprint arXiv:1907.10641 , 2019.\n[SNS+19] Amanpreet Singh, Vivek Natarajan, Meet Shah, Yu Jiang, Xinlei Chen, Dhruv Batra, Devi\nParikh, and Marcus Rohrbach. Towards vqa models that can read, 2019.\n20[SRR+22] Aarohi Srivastava, Abhinav Rastogi, Abhishek Rao, Abu Awal Md Shoeb, Abubakar Abid,\nAdam Fisch, Adam R Brown, Adam Santoro, Aditya Gupta, Adri` a Garriga-Alonso, et al.\nBeyond the imitation game: Quantifying and extrapolating the capabilities of language\nmodels. arXiv preprint arXiv:2206.04615 , 2022.\n[SSS+22] Mirac Suzgun, Nathan Scales, Nathanael Sch¨ arli, Sebastian Gehrmann, Yi Tay, Hyung Won\nChung, Aakanksha Chowdhery, Quoc V. Le, Ed H. Chi, Denny Zhou, and Jason Wei.\nChallenging big-bench tasks and whether chain-of-thought can solve them, 2022.\n[TAB+23] Gemini Team, Rohan Anil, Sebastian Borgeaud, Yonghui Wu, Jean-Baptiste Alayrac, Jiahui\nYu, Radu Soricut, Johan Schalkwyk, Andrew M Dai, Anja Hauth, et al. Gemini: a family\nof highly capable multimodal models. arXiv preprint arXiv:2312.11805 , 2023.\n[THLB19] Alon Talmor, Jonathan Herzig, Nicholas Lourie, and Jonathan Berant. Commonsenseqa: A\nquestion answering challenge targeting commonsense knowledge, 2019.\n[TLI+23] Hugo Touvron, Thibaut Lavril, Gautier Izacard, Xavier Martinet, Marie-Anne Lachaux,\nTimoth´ ee Lacroix, Baptiste Rozi` ere, Naman Goyal, Eric Hambro, Faisal Azhar, Aurelien\nRodriguez, Armand Joulin, Edouard Grave, and Guillaume Lample. Llama: Open and\nefficient foundation language models. arXiv preprint arXiv:2302.13971 , 2023.\n[TMH+24] Gemma Team, Thomas Mesnard, Cassidy Hardin, Robert Dadashi, Surya Bhupatiraju,\nShreya Pathak, Laurent Sifre, Morgane Rivi` ere, Mihir Sanjay Kale, Juliette Love, et al.\nGemma: Open models based on gemini research and technology, 2024.\n[VSP+17] Ashish Vaswani, Noam Shazeer, Niki Parmar, Jakob Uszkoreit, Llion Jones, Aidan N Gomez,\n L ukasz Kaiser, and Illia Polosukhin. Attention is all you need. In Advances in Neural\nInformation Processing Systems , volume 30, 2017.\n[XWX+24] Bin Xiao, Haiping Wu, Weijian Xu, Xiyang Dai, Houdong Hu, Yumao Lu, Michael Zeng,\nCe Liu, and Lu Yuan. Florence-2: Advancing a unified representation for a variety of vision\ntasks. 2024.\n[YHB+22] Greg Yang, Edward J. Hu, Igor Babuschkin, Szymon Sidor, Xiaodong Liu, David Farhi,\nNick Ryder, Jakub Pachocki, Weizhu Chen, and Jianfeng Gao. Tensor programs v: Tuning\nlarge neural networks via zero-shot hyperparameter transfer. 2022.\n[YNZ+23] Xiang Yue, Yuansheng Ni, Kai Zhang, Tianyu Zheng, Ruoqi Liu, Ge Zhang, Samuel Stevens,\nDongfu Jiang, Weiming Ren, Yuxuan Sun, Cong Wei, Botao Yu, Ruibin Yuan, Renliang Sun,\nMing Yin, Boyuan Zheng, Zhenzhu Yang, Yibo Liu, Wenhao Huang, Huan Sun, Yu Su, and\nWenhu Chen. Mmmu: A massive multi-discipline multimodal understanding and reasoning\nbenchmark for expert agi, 2023.\n[ZBY+24] Yongshuo Zong, Ondrej Bohdal, Tingyang Yu, Yongxin Yang, and Timothy Hospedales.\nSafety fine-tuning at (almost) no cost: A baseline for vision large language models. arXiv\npreprint arXiv:2402.02207 , 2024.\n[ZCG+23] Wanjun Zhong, Ruixiang Cui, Yiduo Guo, Yaobo Liang, Shuai Lu, Yanlin Wang, Amin\nSaied, Weizhu Chen, and Nan Duan. Agieval: A human-centric benchmark for evaluating\nfoundation models, 2023.\n21[ZCS+23] Lianmin Zheng, Wei-Lin Chiang, Ying Sheng, Siyuan Zhuang, Zhanghao Wu, Yonghao\nZhuang, Zi Lin, Zhuohan Li, Dacheng Li, Eric Xing, et al. Judging llm-as-a-judge with\nmt-bench and chatbot arena. arXiv preprint arXiv:2306.05685 , 2023.\n[ZHB+19] Rowan Zellers, Ari Holtzman, Yonatan Bisk, Ali Farhadi, and Yejin Choi. Hellaswag: Can\na machine really finish your sentence? In Proceedings of the 57th Annual Meeting of the\nAssociation for Computational Linguistics , pages 4791–4800, 2019.\nA Example prompt for benchmarks\nQuestion:\nSolve for x:(−1\n3)(−4−3x)=1\n2\nOptions:\nA.−5\n6\nB.7\n6\nC.5\n3\nD.1\n6\nAnswer: A\nQuestion:\nWhich of the following is the body cavity that contains the pituitary gland?\nOptions:\nA. Abdominal\nB. Cranial\nC. Pleural\nD. Spinal\nAnswer: B\nQuestion:\nWhere was the most famous site of the mystery cults in Greece?\nOptions:\nA. Ephesus\nB. Corinth\nC. Athens\nD. Eleusis\nAnswer:\n22B Authors (alphabetical)\nMarah Abdin Xin Jin Adil Salim\nJyoti Aneja Nikos Karampatziakis Michael Santacroce\nHany Awadalla Piero Kauffmann Shital Shah\nAhmed Awadallah Mahoud Khademi Ning Shang\nAmmar Ahmad Awan Dongwoo Kim Hiteshi Sharma\nNguyen Bach Young Jin Kim Yelong Shen\nAmit Bahree Lev Kurilenko Swadheen Shukla\nArash Bakhtiari James R. Lee Xia Song\nJianmin Bao Yin Tat Lee Masahiro Tanaka\nHarkirat Behl Yuanzhi Li Andrea Tupini\nAlon Benhaim Yunsheng Li Praneetha Vaddamanu\nMisha Bilenko Chen Liang Chunyu Wang\nJohan Bjorck Lars Liden Guanhua Wang\nS´ ebastien Bubeck Xihui Lin Lijuan Wang\nMartin Cai Zeqi Lin Shuohang Wang\nQin Cai Ce Liu Xin Wang\nVishrav Chaudhary Liyuan Liu Yu Wang\nDong Chen Mengchen Liu Rachel Ward\nDongdong Chen Weishung Liu Wen Wen\nWeizhu Chen Xiaodong Liu Philipp Witte\nYen-Chun Chen Chong Luo Haiping Wu\nYi-Ling Chen Piyush Madan Xiaoxia Wu\nHao Cheng Ali Mahmoudzadeh Michael Wyatt\nParul Chopra David Majercak Bin Xiao\nXiyang Dai Matt Mazzola Can Xu\nMatthew Dixon Caio C´ esar Teodoro Mendes Jiahang Xu\nRonen Eldan Arindam Mitra Weijian Xu\nVictor Fragoso Hardik Modi Jilong Xue\nJianfeng Gao Anh Nguyen Sonali Yadav\nMei Gao Brandon Norick Fan Yang\nMin Gao Barun Patra Jianwei Yang\nAmit Garg Daniel Perez-Becker Yifan Yang\nAllie Del Giorno Thomas Portet Ziyi Yang\nAbhishek Goswami Reid Pryzant Donghan Yu\nSuriya Gunasekar Heyang Qin Lu Yuan\nEmman Haider Marko Radmilac Chenruidong Zhang\nJunheng Hao Liliang Ren Cyril Zhang\nRussell J. Hewett Gustavo de Rosa Jianwen Zhang\nWenxiang Hu Corby Rosset Li Lyna Zhang\nJamie Huynh Sambudha Roy Yi Zhang\nDan Iter Olatunji Ruwase Yue Zhang\nSam Ade Jacobs Olli Saarikivi Yunan Zhang\nMojan Javaheripi Amin Saied Xiren Zhou\n23C Acknowledgements\nWe would like to thank Zhuohan Li, Simon Mo from UC Berkeley and Kaichao You from Tsinghua\nUniversity for sharing their insights on the vLLM kernel.\n24"}